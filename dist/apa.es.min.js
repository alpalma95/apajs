let e=(e,t,s)=>{let[r,n]=((e,t)=>{let[s,r]=e.split("|");return[s.trim(),null==r?void 0:r.split(",").map((e=>{let s=e.trim();if(/^\'|^\"|^\`/.test(s)||"$event"===s)return"$event"===s?s:s.slice(1,-1);try{return JSON.parse(s)}catch{return t[s]}}))]})(t.getAttribute(e));if(!r in s.handlers)return;let a=s.handlers[r],i=e.slice(1);n?t.addEventListener(i,(e=>"$event"===n.at(0)?a(e,...n.slice(1)):a(...n))):t.addEventListener(i,a)},t=(t,s)=>{t.getAttributeNames().filter((e=>e.startsWith(":")||"ref"===e)).forEach((r=>{"ref"==r&&((e,t)=>{let s=e.getAttribute("ref");if(s)if(s in t.$refs)if(t.$refs[s]instanceof HTMLElement){let r=t.$refs[s];t.$refs[s]=new Set,t.$refs[s].add(r).add(e)}else t.$refs[s].add(e);else t.$refs[s]=e})(t,s),r.startsWith(":")&&e(r,t,s)}))},s=e=>{let s=s=>{s.filter((t=>(e=>{let t=e.parentElement;for(;(t=t.parentElement)&&!t.tagName.includes("-"););return t})(t.target)==e)).forEach((s=>{if("childList"!==s.type)return;let{addedNodes:r,removedNodes:a}=s;a.length&&a.forEach((t=>{!t.tagName||!t.getAttribute("ref")||((e,t)=>{let s=e.getAttribute("ref");t.$refs[s]instanceof Set?t.$refs[s].delete(e):delete t.$refs[s]})(t,e.ctx)})),r.length&&r.forEach((async s=>{s.tagName&&(t(s,e.ctx),s.childNodes.length>0&&await n(s,e.ctx))}))}))};return new Promise((e=>{e(new MutationObserver(s))}))},r=(e,s)=>{if(!e)return;const n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>e.getAttributeNames().some((e=>e.startsWith(":")||"ref"===e))?NodeFilter.FILTER_ACCEPT:e.tagName.includes("-")?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP});let a=n.currentNode;for(;a=n.nextNode();)t(a,s);null!==e.shadowRoot&&r(e.shadowRoot,s)},n=(e,t)=>new Promise((s=>{r(e,t),s()})),a=(e,t,r={className:HTMLElement,tag:""})=>{window.customElements.get(e.tag)||window.customElements.define(e.tag,class extends r.className{constructor(){super(),this.ctx={onInit:e=>{},onDestroy:()=>{},host:this,$refs:{},handlers:{},watch:(e,t,s)=>{}},e.shadow&&(this.shadow=this.attachShadow({mode:e.shadow})),"function"==typeof e.onConstruct&&e.onConstruct(this)}static get observedAttributes(){return e.observed}connectedCallback(){let r={};this.getAttributeNames().forEach((e=>{let t=this.getAttribute(e);try{r[e]=JSON.parse(t)}catch{r[e]=t}})),this.ctx.props=r,this.ctx.handlers={};let a=this.shadowRoot??this;if(a.innerHTML=t(this.ctx),!e.isStateless){(async()=>{await n(this,this.ctx)})();let e={childList:!0,subtree:!0};s(this).then((t=>{this.shadowRoot&&t.observe(this.shadowRoot,e),t.observe(this,e),this.ctx.onInit(a)}))}}attributeChangedCallback(e,t,s){this.ctx.watch(e,t,s)}disconnectedCallback(){this.ctx.onDestroy()}},r.className!==HTMLElement?{extends:null==r?void 0:r.tag}:{})},{isArray:i}=Array,o=(e,...t)=>{let s=t.map((e=>e instanceof HTMLElement?e.outerHTML:i(e)?e.join(" "):e));return e.reduce(((e,t,r)=>e+t+(s[r]??"")),"")},l=null,c=new WeakMap;class d{constructor(e){this.cb=e,this._set=new Set}unhook(){this._set.forEach((e=>e.delete(this)))}}let h=e=>{l=new d(e),l.cb();let t=l;return l=null,t},f=e=>{let t=(e=>{if(Array.isArray(e)||"function"!=typeof e&&"object"!=typeof e)return{val:e};if("function"==typeof e){let t=f(1);return h((()=>t.val=e())),t}return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,"object"==typeof t||"function"==typeof t?f(t):t])))})(e);return new Proxy(t,{get:(e,t,s)=>(((e,t)=>{if(null===l)return;let s;c.has(e)?s=c.get(e).get(t):c.set(e,new Map([[t,s=new Set]])),l._set.add(s),s.add(l)})(e,t),Reflect.get(e,t,s)),set:(e,t,s,r)=>(e[t]!==s&&(Reflect.set(e,t,s,r),((e,t)=>{c.get(e)&&c.get(e).get(t).forEach((({cb:e})=>e()))})(e,t)),!0)})};export{a as define,h as hook,o as html,f as stream};
//# sourceMappingURL=apa.min.js.map