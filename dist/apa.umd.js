(function(f,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(f=typeof globalThis<"u"?globalThis:f||self,h(f.apajs={}))})(this,function(f){"use strict";let h=(t,r)=>{let[e,s]=t.split("|");return[e.trim(),s==null?void 0:s.split(",").map(i=>{let n=i.trim();if(/^\'|^\"|^\`/.test(n)||n==="$event")return n==="$event"?n:n.slice(1,-1);try{return JSON.parse(n)}catch{return r[n]}})]},w=(t,r,e)=>{let[s,i]=h(r.getAttribute(t));if(!s in e.handlers)return;let n=e.handlers[s],a=t.slice(1);i?r.addEventListener(a,l=>i.at(0)==="$event"?n(l,...i.slice(1)):n(...i)):r.addEventListener(a,n)},E=(t,r)=>{let e=t.getAttribute("ref");if(e)if(e in r.$refs)if(r.$refs[e]instanceof HTMLElement){let s=r.$refs[e];r.$refs[e]=new Set,r.$refs[e].add(s).add(t)}else r.$refs[e].add(t);else r.$refs[e]=t},g=(t,r)=>{let e=t.getAttribute("ref");r.$refs[e]instanceof Set?r.$refs[e].delete(t):delete r.$refs[e]},u=(t,r)=>{t.getAttributeNames().filter(e=>e.startsWith(":")||e==="ref").forEach(e=>{e=="ref"&&E(t,r),e.startsWith(":")&&w(e,t,r)})},y=t=>{let r=t.parentElement;for(;(r=r.parentElement)&&!r.tagName.includes("-"););return r},N=t=>{let r=e=>{e.filter(i=>y(i.target)==t).forEach(i=>{if(i.type!=="childList")return;let{addedNodes:n,removedNodes:a}=i;a.length&&a.forEach(l=>{!l.tagName||!l.getAttribute("ref")||g(l,t.ctx)}),n.length&&n.forEach(async l=>{l.tagName&&(u(l,t.ctx),l.childNodes.length>0&&await p(l,t.ctx))})})};return new Promise(e=>{e(new MutationObserver(r))})},m=(t,r)=>{if(!t)return;const e=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,{acceptNode(i){return i.getAttributeNames().some(n=>n.startsWith(":")||n==="ref")?NodeFilter.FILTER_ACCEPT:i.tagName.includes("-")?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}});let s=e.currentNode;for(;s=e.nextNode();)u(s,r);t.shadowRoot!==null&&m(t.shadowRoot,r)},p=(t,r)=>new Promise(e=>{m(t,r),e()}),A=(t,r)=>{window.customElements.define(t.tag,class extends HTMLElement{constructor(){super(),this.ctx={onInit:e=>{},onDestroy:()=>{},host:this,$refs:{},handlers:{},watch:(e,s,i)=>{}},t.shadow&&(this.shadow=this.attachShadow({mode:t.shadow})),typeof t.onConstruct=="function"&&t.onConstruct(this)}static get observedAttributes(){return t.observed}connectedCallback(){let e={};this.getAttributeNames().forEach(n=>{let a=this.getAttribute(n);try{e[n]=JSON.parse(a)}catch{e[n]=a}}),this.ctx.props=e,this.ctx.handlers={};let s=this.shadowRoot??this;s.innerHTML=r(this.ctx),(async()=>await p(this,this.ctx))();let i={childList:!0,subtree:!0};N(this).then(n=>{this.shadowRoot&&n.observe(this.shadowRoot,i),n.observe(this,i),this.ctx.onInit(s)})}attributeChangedCallback(e,s,i){this.ctx.watch(e,s,i)}disconnectedCallback(){this.ctx.onDestroy()}})},{isArray:T}=Array,R=(t,...r)=>{let e=r.map(s=>s instanceof HTMLElement?s.outerHTML:T(s)?s.join(" "):s);return t.reduce((s,i,n)=>s+i+(e[n]??""),"")},o=null,d=new WeakMap;class ${constructor(r){this.cb=r,this._set=new Set}unhook(){this._set.forEach(r=>r.delete(this))}}let b=t=>{o=new $(t),o.cb();let r=o;return o=null,r},C=(t,r)=>{if(o===null)return;let e;d.has(t)?e=d.get(t).get(r):d.set(t,new Map([[r,e=new Set]])),o._set.add(e),e.add(o)},L=(t,r)=>{if(!d.get(t))return;d.get(t).get(r).forEach(({cb:s})=>s())},v=t=>{if(Array.isArray(t)||typeof t!="function"&&typeof t!="object")return{val:t};if(typeof t=="function"){let r=c(1);return b(()=>r.val=t()),r}else return Object.fromEntries(Object.entries(t).map(([r,e])=>[r,typeof e=="object"||typeof e=="function"?c(e):e]))},c=t=>{let r=v(t);return new Proxy(r,{get(e,s,i){return C(e,s),Reflect.get(e,s,i)},set(e,s,i,n){return e[s]!==i&&(Reflect.set(e,s,i,n),L(e,s)),!0}})};f.define=A,f.hook=b,f.html=R,f.stream=c,Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});
